#!/bin/bash

# --- Functions ---

spinner() {
    local pid=$1
    local delay=0.1
    local spinstr='|/-\'
    tput civis # Hide cursor
    while [ -d /proc/$pid ] || ps -p $pid > /dev/null 2>&1; do
        local temp=${spinstr#?}
        printf "\r [%c] Scanning /Applications for candidates..." "$spinstr"
        local spinstr=$temp${spinstr%"$temp"}
        sleep $delay
    done
    tput cnorm # Show cursor
    printf "\r [âœ“] Scanning /Applications for candidates... Done!\n"
}

echo "ðŸº Brew-Migrator: Homebrew Conversion Tool"
echo "-------------------------------------------------------"

# 1. Selection Mode
echo "Select mode:"
echo "1) Live Conversion"
echo "2) Dry Run (Default)"
read -p "Selection [1/2]: " mode_choice

DRY_RUN=true
[[ "$mode_choice" == "1" ]] && DRY_RUN=false

if [ "$DRY_RUN" = true ]; then
    echo "ðŸ›¡ï¸  DRY RUN MODE ACTIVE"
else
    echo "ðŸš€ LIVE MODE ACTIVE"
fi
echo "-------------------------------------------------------"

# 2. Scanning with Spinner
(
    rm -f /tmp/brew_matches.txt
    INSTALLED_CASKS=$(brew list --cask -1 2>/dev/null)

    find /Applications -maxdepth 1 -name "*.app" | while read -r app_path; do
        app_name=$(basename "$app_path" .app)
        token=$(echo "$app_name" | tr '[:upper:]' '[:lower:]' | sed 's/ /-/g' | sed 's/[()//]//g')

        if ! echo "$INSTALLED_CASKS" | grep -q "^$token$"; then
            if brew info --cask "$token" &>/dev/null; then
                echo "$app_name|$token" >> /tmp/brew_matches.txt
            fi
        fi
    done
) & 

SCAN_PID=$!
spinner $SCAN_PID

# Read results (Bash 3.2+ compatible)
results=()
if [ -f /tmp/brew_matches.txt ]; then
    while IFS= read -r line; do
        results+=("$line")
    done < /tmp/brew_matches.txt
    rm /tmp/brew_matches.txt
fi

echo "-------------------------------------------------------"

# 3. Process results
app_names=()
app_tokens=()

for line in "${results[@]}"; do
    app_names+=("${line%%|*}")
    app_tokens+=("${line##*|}")
done

if [ ${#app_names[@]} -eq 0 ]; then
    echo "No new candidates found. You're all set!"
    exit 0
fi

# 4. Display Menu
for i in "${!app_names[@]}"; do
    printf "%2d) %-25s (%s)\n" "$((i+1))" "${app_names[$i]}" "${app_tokens[$i]}"
done

echo "-------------------------------------------------------"
echo "Enter numbers to convert (e.g., '1 3 5') or ENTER for ALL."
read -p "Selection: " input

# 5. Selection Logic
to_install=()
if [ -z "$input" ]; then
    to_install=("${app_tokens[@]}")
else
    for num in $input; do
        index=$((num-1))
        [[ $index -ge 0 && $index -lt ${#app_tokens[@]} ]] && to_install+=("${app_tokens[$index]}")
    done
fi

# 6. Execution
for token in "${to_install[@]}"; do
    if [ "$DRY_RUN" = false ]; then
        if pgrep -f "$token" > /dev/null; then
            echo "âš ï¸  $token is running. Please close it and try again."
            continue
        fi
        echo "--> Installing $token..."
        brew install --cask --force "$token"
    else
        echo "[DRY RUN] Would run: brew install --cask --force $token"
    fi
done

if [ "$DRY_RUN" = false ] && [ ${#to_install[@]} -gt 0 ]; then
    echo "Updating ~/.Brewfile..."
    brew bundle dump --file="$HOME/.Brewfile" --force 2>/dev/null
    echo "Success! Your apps are now managed by Homebrew."
fi